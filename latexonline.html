<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Graficador LaTeX con Control de Tamaño y Exportación SVG</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script>
      window.MathJax = {
        loader: { load: ["input/tex", "output/svg"] },
        svg: {
          fontCache: "none",
        },
      };
    </script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.10/lib/umd.min.js"></script>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="bg-gray-100 py-2 px-4 rounded-md shadow-sm mb-6">
      <nav class="text-sm" aria-label="Miga de pan">
        <ol class="list-none p-0 inline-flex space-x-2">
          <li class="flex items-center">
            <a
              href="herramientas.html"
              class="text-blue-500 hover:text-blue-700"
            >
              <i
                data-lucide="wrench-screwdriver"
                class="inline-block w-4 h-4 mr-1 align-text-bottom"
              ></i>
              Herramientas
            </a>
          </li>
          <li>
            <i
              data-lucide="chevron-right"
              class="inline-block w-4 h-4 text-gray-400 align-text-bottom"
            ></i>
          </li>
          <li class="text-gray-700">Graficador ecuaciones LaTeX</li>
        </ol>
      </nav>
    </div>
    <div
      class="mx-auto bg-white shadow-md rounded-md p-6 w-full md:w-9/10 lg:w-9/10 xl:w-9/10"
    >
      <h1 class="text-2xl font-semibold mb-4 text-gray-800">
        Graficador de ecuaciones LaTeX
      </h1>
      <div class="mb-4">
        <label
          for="latexInput"
          class="block text-gray-700 text-sm font-bold mb-2"
          >Introduce tu código LaTeX:</label
        >
        <textarea
          id="latexInput"
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          rows="3"
          placeholder="Ejemplo: y = x^2"
        ></textarea>
      </div>
      <div class="mb-4 space-x-2">
        <button
          onclick="insertarLatex('\\dfrac{a}{b}')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold px-2 py-1 rounded"
        >
          Fracción
        </button>
        <button
          onclick="insertarLatex('\\sqrt{x}')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold px-2 py-1 rounded"
        >
          Raíz
        </button>
        <button
          onclick="insertarLatex('x^{n}')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold px-2 py-1 rounded"
        >
          Potencia
        </button>
        <button
          onclick="insertarLatex('\\int_a^b')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold px-2 py-1 rounded"
        >
          Integral
        </button>
        <button
          onclick="insertarLatex('\\sum_{i=1}^n')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold px-2 py-1 rounded"
        >
          Sumatoria
        </button>
      </div>
      <div class="mb-4 space-x-2">
        <button
          onclick="graficar()"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
        >
          Graficar
        </button>
        <button
          onclick="aumentarTamano()"
          class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
        >
          +
        </button>
        <button
          onclick="disminuirTamano()"
          class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
        >
          -
        </button>
        <button
          onclick="descargarPNG()"
          class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
        >
          Exportar PNG
        </button>
        <button
          onclick="copiarPNGAlPortapapeles()"
          class="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
        >
          Copiar PNG
        </button>
      </div>
      <div id="output" class="mt-6 text-center" style="font-size: 16px"></div>
      <div class="mt-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Historial</h2>
        <ul
          id="historial"
          class="space-y-1 text-sm text-blue-600 cursor-pointer"
        >
          <button
            onclick="borrarTodoHistorial()"
            class="mt-2 bg-red-200 hover:bg-red-400 text-red-800 text-xs font-semibold py-1 px-2 rounded"
          >
            Borrar todo el historial
          </button>
        </ul>
      </div>
      <p class="mt-4 text-gray-500 text-sm">
        Powered by
        <a
          href="https://www.mathjax.org/"
          target="_blank"
          class="text-blue-500 hover:underline"
          >MathJax</a
        >
        .
      </p>
    </div>
    <div
      id="message-container"
      class="fixed top-5 right-5 z-50 space-y-2"
    ></div>

    <script>
      let currentFontSize = 16; // Tamaño de fuente inicial en píxeles
      const outputDiv = document.getElementById("output");

      function graficar() {
        const latexInput = document.getElementById("latexInput").value;
        guardarEnHistorial(latexInput);

        // Limpiar el contenido anterior
        outputDiv.innerHTML = "$$" + latexInput + "$$";

        // Establecer el tamaño de fuente actual
        outputDiv.style.fontSize = currentFontSize + "px";

        // Volver a renderizar MathJax
        MathJax.typesetPromise([outputDiv]).then(() => {});
      }

      function aumentarTamano() {
        currentFontSize += 2;
        outputDiv.style.fontSize = currentFontSize + "px";
        MathJax.typesetPromise([outputDiv]).then(() => {});
      }

      function disminuirTamano() {
        currentFontSize -= 2;
        if (currentFontSize < 10) {
          // Evitar que el tamaño sea demasiado pequeño
          currentFontSize = 10;
        }
        outputDiv.style.fontSize = currentFontSize + "px";
        MathJax.typesetPromise([outputDiv]).then(() => {});
      }

      function descargarSVG() {
        setTimeout(() => {
          const svgElement = outputDiv.querySelector("svg");
          if (svgElement) {
            const svg = svgElement.outerHTML;
            const filename = "ecuacion.svg";
            const svgData = new Blob([svg], {
              type: "image/svg+xml;charset=utf-8",
            });
            const url = URL.createObjectURL(svgData);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
          } else {
            mostrarMensaje("Por favor, grafica una ecuación primero.");
          }
        }, 100);
      }

      async function copiarSVGAlPortapapeles() {
        setTimeout(async () => {
          const svgElement = outputDiv.querySelector("svg");
          if (svgElement) {
            const svg = svgElement.outerHTML;
            try {
              await navigator.clipboard.writeText(svg);
              mostrarMensaje("Código SVG copiado al portapapeles.");
            } catch (err) {
              console.error("Error al copiar SVG:", err);
              mostrarMensaje(
                "Tu navegador no soporta la copia directa de SVG al portapapeles."
              );
            }
          } else {
            mostrarMensaje("Por favor, grafica una ecuación primero.");
          }
        }, 100);
      }
      async function descargarPNG() {
        const svgElement = outputDiv.querySelector("svg");
        if (!svgElement) {
          mostrarMensaje("Primero debes graficar una ecuación.");
          return;
        }

        const clonedSvg = svgElement.cloneNode(true);
        clonedSvg.setAttribute("xmlns", "http://www.w3.org/2000/svg");

        const bbox = svgElement.getBBox();
        const width = Math.ceil(bbox.width + 20);
        const height = Math.ceil(bbox.height + 20);
        clonedSvg.setAttribute("width", width);
        clonedSvg.setAttribute("height", height);

        const svgString = new XMLSerializer().serializeToString(clonedSvg);
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");

        // Usa canvg para dibujar SVG en el canvas
        const v = await canvg.Canvg.from(ctx, svgString);
        await v.render();

        const pngUrl = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = pngUrl;
        link.download = "ecuacion.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      async function copiarPNGAlPortapapeles() {
        const svgElement = outputDiv.querySelector("svg");
        if (!svgElement) {
          mostrarMensaje("Primero debes graficar una ecuación.");
          return;
        }

        const clonedSvg = svgElement.cloneNode(true);
        clonedSvg.setAttribute("xmlns", "http://www.w3.org/2000/svg");

        const bbox = svgElement.getBBox();
        const width = Math.ceil(bbox.width + 20);
        const height = Math.ceil(bbox.height + 20);
        clonedSvg.setAttribute("width", width);
        clonedSvg.setAttribute("height", height);

        const svgString = new XMLSerializer().serializeToString(clonedSvg);
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");

        const v = await canvg.Canvg.from(ctx, svgString);
        await v.render();

        canvas.toBlob(async (blob) => {
          try {
            await navigator.clipboard.write([
              new ClipboardItem({ "image/png": blob }),
            ]);
            mostrarMensaje("✅ Imagen PNG copiada al portapapeles.");
          } catch (err) {
            console.error("Error al copiar:", err);
            mostrarMensaje("❌ No se pudo copiar. ¿Tu navegador lo permite?");
          }
        }, "image/png");
      }
      function mostrarMensaje(texto, tipo = "success") {
        const container = document.getElementById("message-container");
        const id = "msg-" + Date.now();

        const bgColor =
          tipo === "success"
            ? "bg-green-100 border-green-400 text-green-700"
            : "bg-red-100 border-red-400 text-red-700";

        const html = `
    <div id="${id}" class="border ${bgColor} px-4 py-3 rounded relative shadow-md" role="alert">
      <span class="block sm:inline">${texto}</span>
      <span
        onclick="document.getElementById('${id}').remove()"
        class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer text-2xl leading-none"
      >
        &times;
      </span>
    </div>
  `;

        container.insertAdjacentHTML("beforeend", html);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          const el = document.getElementById(id);
          if (el) el.remove();
        }, 5000);
      }
      function insertarLatex(texto) {
        const textarea = document.getElementById("latexInput");
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const contenido = textarea.value;

        // Insertar el snippet en la posición del cursor
        textarea.value =
          contenido.substring(0, start) + texto + contenido.substring(end);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + texto.length;
      }
      function guardarEnHistorial(equation) {
        let historial = JSON.parse(
          localStorage.getItem("latexHistorial") || "[]"
        );
        if (!historial.includes(equation)) {
          historial.unshift(equation);
          if (historial.length > 20) historial.pop(); // Limitar a 20 entradas
          localStorage.setItem("latexHistorial", JSON.stringify(historial));
          renderizarHistorial();
        }
      }

      function renderizarHistorial() {
        const historial = JSON.parse(
          localStorage.getItem("latexHistorial") || "[]"
        );
        const ul = document.getElementById("historial");
        ul.innerHTML = "";
        historial.forEach((eq, index) => {
          const li = document.createElement("li");
          li.classList.add(
            "flex",
            "items-center",
            "justify-between",
            "bg-white",
            "rounded",
            "px-3",
            "py-1",
            "shadow-sm",
            "hover:bg-gray-50"
          );

          const span = document.createElement("span");
          span.textContent = eq;
          span.classList.add("cursor-pointer", "hover:underline", "flex-grow");
          span.onclick = () => {
            document.getElementById("latexInput").value = eq;
            graficar();
          };

          const btn = document.createElement("button");
          btn.innerHTML = "&times;";
          btn.classList.add(
            "text-red-500",
            "ml-3",
            "hover:text-red-700",
            "text-lg",
            "font-bold"
          );
          btn.onclick = () => eliminarDelHistorial(index);

          li.appendChild(span);
          li.appendChild(btn);
          ul.appendChild(li);
        });
      }
      function eliminarDelHistorial(index) {
        let historial = JSON.parse(
          localStorage.getItem("latexHistorial") || "[]"
        );
        historial.splice(index, 1);
        localStorage.setItem("latexHistorial", JSON.stringify(historial));
        renderizarHistorial();
      }
      function borrarTodoHistorial() {
        if (confirm("¿Estás seguro de borrar todo el historial?")) {
          localStorage.removeItem("latexHistorial");
          renderizarHistorial();
        }
      }
    </script>
  </body>
</html>
